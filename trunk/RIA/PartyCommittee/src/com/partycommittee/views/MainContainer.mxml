<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:fx="http://ns.adobe.com/mxml/2009"
		   xmlns:s="library://ns.adobe.com/flex/spark"
		   xmlns:mx="library://ns.adobe.com/flex/mx" 
		   width="100%" height="100%" 
		   xmlns:control="com.partycommittee.control.*" 
		   xmlns:closebox="com.partycommittee.control.closebox.*" 
		   xmlns:partymember="com.partycommittee.views.partymember.*" 
		   xmlns:tree="com.partycommittee.control.tree.*" 
		   xmlns:agencyviews="com.partycommittee.views.agencymgmt.agencyviews.*" 
		   xmlns:systemviews="com.partycommittee.views.sysmgmt.systemviews.*"
		   creationComplete="onCreationCompleted()" 
		   xmlns:agencyactivity="com.partycommittee.views.agencymgmt.agencyactivity.*" 
		   xmlns:agencymgmt="com.partycommittee.views.agencymgmt.*">
	
	<fx:Script>
		<![CDATA[
			import com.partycommittee.control.tree.classes.Node;
			import com.partycommittee.events.AccordionItemClickEvent;
			import com.partycommittee.events.PcAgencyEvent;
			import com.partycommittee.events.PcUserEvent;
			import com.partycommittee.manager.navigation.NavigationMgr;
			import com.partycommittee.manager.tree.TreeContextMenuMgr;
			import com.partycommittee.model.ModelLocator;
			import com.partycommittee.vo.PcAgencyVo;
			import com.partycommittee.vo.PcUserVo;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.events.DividerEvent;
			
			[Bindable]
			private var model:ModelLocator = ModelLocator.getInstance();
			
			private function onCreationCompleted():void {
				model.tree = this.tree;
				TreeContextMenuMgr.getInstance().registeContextMenu(tree);
				
				hDivBox.liveDragging = true;
				hDivBox.doubleClickEnabled = true;
				hDivBox.getDividerAt(0).addEventListener(MouseEvent.DOUBLE_CLICK, onDividerDoubleClick);
				
				initUserData();
			}
			
			private function initUserData():void {
				var userEvent:PcUserEvent = new PcUserEvent(PcUserEvent.GET_SESSION);
				userEvent.successCallback = onGetSessionSuccess;
				userEvent.dispatch();
			}
			
			private function onGetSessionSuccess(data:Object, evt:PcUserEvent):void {
				var user:PcUserVo = data as PcUserVo;
				model.loginUser = user;
				if (!user) {
//					var agencyEvent:PcAgencyEvent = new PcAgencyEvent(PcAgencyEvent.GET_ROOT_AGENCY_BY_USERID);
//					agencyEvent.userId = 1;
//					agencyEvent.failureCallback = noAgencyHandler;
//					agencyEvent.dispatch();
					return;
				}
				
				// Load agency by 
				var agencyEvent:PcAgencyEvent = new PcAgencyEvent(PcAgencyEvent.GET_ROOT_AGENCY_BY_USERID);
				agencyEvent.userId = model.loginUser.id;
				agencyEvent.failureCallback = noAgencyHandler;
				agencyEvent.dispatch();
			}
			
			private var _isTreeMinSize:Boolean = false;
			private var _treeNormalSize:Number = 228;
			private function onDividerDoubleClick(event:MouseEvent):void {
				if (this._isTreeMinSize) {
					expandTree();
				} else {
					unExpandTree();
				}
			}
			
			private function expandTree():void {
				treeBox.width = this._treeNormalSize;
				this._isTreeMinSize = false;
			}
			
			private function unExpandTree():void {
				this._treeNormalSize = treeBox.width;
				treeBox.width = 0;
				this._isTreeMinSize = true;
			}
			
			private function noAgencyHandler(info:Object, evt:PcAgencyEvent):void {
				Alert.show("该用户没有分配任何组织管理权限！");
			}
			
			private function onItemClick():void {
				var focusNode:Node = tree.selectedItem as Node;
				if (!focusNode.entity) {
					return;
				}
				var focusAgency:PcAgencyVo = focusNode.entity as PcAgencyVo;
				model.focusAgencyVo = focusAgency;
			}
		]]>
	</fx:Script>
	
	<mx:Canvas id="container" width="100%" height="100%">
		<mx:HDividedBox id="hDivBox" width="100%" height="100%">
			<mx:VBox id="treeBox" width="228" height="100%"
					 horizontalScrollPolicy="off" verticalScrollPolicy="off">
				<tree:LoadingTree id="tree" width="100%" height="100%" 
								  dataProvider="{model.treeCollection}"
								  itemClick="onItemClick()"/>
				<tree:TreeControlBar width="100%"/>
			</mx:VBox>
			<mx:ViewStack id="mainViewStack" width="100%" height="100%" creationPolicy="all"
						  left="6" right="6" top="6" bottom="6">
				<agencymgmt:OrgView id="orgView" width="100%" height="100%" viewStack="{mainViewStack}"/>
				<agencyactivity:AgencyActivityView id="agencyActivityView" width="100%" height="100%" viewStack="{mainViewStack}"/>
				<systemviews:AccountManageView id="accountView" width="100%" height="100%" viewStack="{mainViewStack}"/>
			</mx:ViewStack>
		</mx:HDividedBox>
	</mx:Canvas>
	
</mx:Canvas>
