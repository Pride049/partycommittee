<?xml version="1.0" encoding="utf-8"?>
<mx:Box xmlns:fx="http://ns.adobe.com/mxml/2009"
        xmlns:s="library://ns.adobe.com/flex/spark"
        xmlns:mx="library://ns.adobe.com/flex/mx" 
        xmlns:controls="com.hp.client.controls.*"
        horizontalAlign="center"
        verticalAlign="middle"
        creationComplete="onCreationCompleted()">
	
	<fx:Script>
		<![CDATA[
			import com.partycommittee.events.PcUserEvent;
			import com.partycommittee.model.ModelLocator;
			import com.partycommittee.vo.PcUserVo;
			
			import mx.controls.Alert;
			
			public static const CACHE_USERNAME:String = "PartyCommitteeUser";
			
			public static const LOGIN_VIEW:String = "loginView";
			public static const OPERATING_VIEW:String = "operatingView";
			
			[Bindable]
			public var loginUsernameValid:Boolean;
			[Bindable]
			public var registerUsernameValid:Boolean;
			[Bindable]
			public var registerPasswordValid:Boolean;
			[Bindable]
			public var phoneValid:Boolean = true;
			
			[Bindable]
			public var loginTitleString:String = "";
			[Bindable]
			public var validateFailureString:String;
			
			[Bindable]
			public var model:ModelLocator = ModelLocator.getInstance();
			
			private var shareObj:SharedObject;
			private function onCreationCompleted():void {
				shareObj = SharedObject.getLocal(CACHE_USERNAME);
				if (shareObj) {
					loginUsernameTextInput.text = shareObj.data.username;
					passwordTextInput.text = shareObj.data.password;
					rememberMeCheckBox.selected = true;
					loginUsernameValid = true;
				}
			}
			
			private function loginBtnClick():void {
				login(getUser());
			}
			
			private var tempUser:PcUserVo;
			private var timer:Timer;
			private function login(user:PcUserVo):void {
				var loginEvent:PcUserEvent = new PcUserEvent(PcUserEvent.LOGIN);
				loginEvent.user = user;
				loginEvent.failureCallback = onLoginFailure;
				loginEvent.dispatch();
				currentState = OPERATING_VIEW;
				
				// Save cookie.
				if (rememberMeCheckBox.selected) {
					shareObj.data.username = user.username;
					shareObj.data.password = user.password;
					shareObj.flush();
				}
			}
			
			private function onLoginFailure(info:Object):void {
				if (info) {
					Alert.show("Login failure!" + info.toString());
				} else {
					Alert.show("Login failure! Username or password is error!");
				}
				currentState = LOGIN_VIEW;
			}
			
			private function resetView():void {
				currentState = LOGIN_VIEW;
				resetLoginView();
			}
			
			private function resetLoginView():void {
				loginUsernameTextInput.text = "";
				passwordTextInput.text = "";
			}
			
			private function getUser():PcUserVo {
				var user:PcUserVo = new PcUserVo();
				user.username = loginUsernameTextInput.text;
				user.password = passwordTextInput.text;
				return user;
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
	</fx:Declarations>
	
	<mx:states>
		<mx:State name="loginView"/>
		<mx:State name="operatingView"/>
	</mx:states>
	
	<mx:Panel id="loginAndRegView"
			  horizontalScrollPolicy="off" verticalScrollPolicy="off"
			  height="400" width="960"
			  title="{loginTitleString}"
			  backgroundAlpha="0.5">
		<mx:HBox width="100%" height="100%"
				 horizontalAlign="center" verticalAlign="middle"
				 visible.loginView="true"
				 includeInLayout.loginView="true"
				 visible.operatingView="false"
				 includeInLayout.operatingView="false">
			<mx:HBox top="headerRow:0" bottom="headerRow:0"
					 width="100%" horizontalGap="0">
				<s:SWFLoader source="{EmbedResources.topBannerSWF}"/>
			</mx:HBox>
			<mx:Label id="companyNameLbl" text="北京市公安局基层党支部组织生活会" fontSize="20"/>
		</mx:HBox>
		
		<!-- Login Form -->
		<mx:VBox width="100%"
				 verticalGap="5" horizontalAlign="center"
				 visible.loginView="true"
				 includeInLayout.loginView="true"
				 visible.operatingView="false"
				 includeInLayout.operatingView="false">
			<mx:Form width="100%" height="100%">
				<mx:FormItem required="true" label="用户名:" width="100%">
					<mx:TextInput id="loginUsernameTextInput" maxChars="32"
								  borderStyle="solid" borderColor="#C3C3C3" width="180"/>
				</mx:FormItem>
				<mx:FormItem required="true" label="密码:" width="100%">
					<mx:TextInput id="passwordTextInput" displayAsPassword="true" maxChars="32"
								  borderStyle="solid" borderColor="#C3C3C3" width="180"/>
				</mx:FormItem>
				<mx:FormItem width="100%">
					<mx:CheckBox id="rememberMeCheckBox" 
								 label="记住密码"
								 selected="false"/>
				</mx:FormItem>
			</mx:Form>
			<mx:ControlBar width="100%" horizontalAlign="left">
				<mx:Button id="loginButton" label="登录"
						   click="loginBtnClick()"
						   enabled="{loginUsernameValid &amp;&amp; passwordTextInput.text != ''}"/>
			</mx:ControlBar>
		</mx:VBox>
		
		<!-- Logining View -->
		<mx:VBox width="480" height="100" 
				 horizontalAlign="center" verticalAlign="middle"
				 includeInLayout.loginView="false"
				 visible.loginView="false"
				 includeInLayout.operatingView="true"
				 visible.operatingView="true">
			<mx:Label text="登录中...请稍候" fontWeight="bold" fontSize="18"/>
			<mx:ProgressBar width="70%" height="20" label="" labelPlacement="center"
							horizontalCenter="0" verticalCenter="0" indeterminate="true"/>
		</mx:VBox>
	</mx:Panel>
	
	<mx:transitions>
		<mx:Transition fromState="loginView" toState="operatingView">
			<mx:Resize target="{loginAndRegView}" duration="500"
					   heightTo="150" widthTo="500"/>
		</mx:Transition>
		<mx:Transition fromState="operatingView" toState="loginView">
			<mx:Resize target="{loginAndRegView}" duration="500"
					   heightTo="350" widthTo="400"/>
		</mx:Transition>
	</mx:transitions>
   
</mx:Box>